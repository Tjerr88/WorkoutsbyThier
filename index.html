<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>OmniFlow Trainer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class'}</script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    html,body { height:100%; }
    body { -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.65rem 1rem;border-radius:.85rem;box-shadow:0 1px 2px rgba(0,0,0,.08);border:1px solid transparent;background:#4f46e5;color:#fff;font-weight:700;font-size:1rem}
    .btn:hover{background:#6366f1}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent;border-color:rgba(0,0,0,.15);color:#111}
    .dark .btn.ghost{border-color:rgba(255,255,255,.2);color:#eee}
    .card{border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.1);background:#fff}
    .dark .card{background:#0b0b0b;border-color:rgba(255,255,255,.1)}
    .muted{color:#52525b}.dark .muted{color:#a1a1aa}
    .mono{font-variant-numeric: tabular-nums}
    .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .6rem;border-radius:999px;background:rgba(79,70,229,.1);color:#4338ca;font-size:.8rem}
    .dark .chip{background:rgba(79,70,229,.2);color:#c7d2fe}
    input[type=range]{accent-color:#4f46e5}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.75rem}
    @media (max-width:640px){
      .grid-2{grid-template-columns:1fr}
      .btn{width:100%}
    }
    .stickybar{position:sticky;bottom:.5rem;z-index:40}
    .stickywrap{backdrop-filter: blur(8px); background: rgba(18,18,18,.5); border-radius: .85rem; border:1px solid rgba(255,255,255,.15)}
    .light .stickywrap{background: rgba(255,255,255,.7); border-color: rgba(0,0,0,.1)}
    details.settings>summary{cursor:pointer;list-style:none}
    details.settings>summary::-webkit-details-marker{display:none}
  </style>
</head>
<body class="bg-zinc-50 dark:bg-black text-zinc-900 dark:text-zinc-100">
  <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6"></div>

  <script type="text/babel" data-presets="react,env">
    const { useState, useEffect } = React;

    // ---------- Utilities ----------
    const todayStr = () => new Date().toLocaleDateString('nl-NL', { year:'numeric', month:'2-digit', day:'2-digit' });
    const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
    const wpick = (pairs) => { let s=0; for(const p of pairs) s+=p.w; let r=Math.random()*s; for(const p of pairs){ r-=p.w; if(r<=0) return p.item; } return pairs[pairs.length-1].item; };

    // ---------- Local Storage ----------
    const LS_KEY='omniflow_trainer_state_v8';
    const def = () => ({
      rotationIndex:0,
      cycleWeek:1, // 1..4 (4 = deload)
      cycleNumber:1,
      history:[],
      lastCoreIndex: -1,
      settings:{ 
        machines:true, machineBias:60, stanceCycle:true,
        modalities:{ barbell:true, dumbbell:true, kettlebell:true, machine:true },
        cardio:{ zone2:true, hiit:true },
      },
      lockedMains:null, // {cycleNumber, S1:{...}, S2:{...}, S3:{...}}
    });
    const load = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)) || def(); }catch(e){ return def(); } };
    const save = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));

    // Helper to pick from enabled modalities; falls back if empty
    const enabledFrom = (modalities, poolsObj, vari) => {
      const keys = Object.entries(modalities).filter(([,v])=>v).map(([k])=>k);
      let pool=[];
      for(const m of keys){ const sub=poolsObj[m]?.[vari]||[]; pool=pool.concat(sub); }
      if(pool.length===0){
        for(const m of Object.keys(poolsObj)){ pool=pool.concat(poolsObj[m]?.[vari]||[]); }
      }
      return pool.length? pick(pool) : '—';
    };

    // ---------- Data Pools (per modality & variatie) ----------
    // SQUAT
    const squatPools = {
      barbell: {
        symmetrical: [ 'Back Squat', 'Front Squat', 'Zercher Squat' ],
        asym: [ 'Barbell Split Squat', 'Reverse Lunge (BB)', 'Walking Lunge (BB)' ],
        single: [ 'Barbell Step-up', 'Skater Squat (counterbalance)', 'Box Pistol (counterweight)' ],
      },
      dumbbell: {
        symmetrical: [ 'Goblet Squat', 'DB Front Squat (dual front rack)', 'DB Box Squat' ],
        asym: [ 'Bulgarian Split Squat (DB)', 'Reverse Lunge (DB)', 'Split Squat (DB)' ],
        single: [ 'DB Step-up', 'Skater Squat (DB)', 'Pistol to Box (DB counterbalance)' ],
      },
      kettlebell: {
        symmetrical: [ 'KB Front Rack Squat (double)', 'Goblet Squat', 'KB Zercher (horns)' ],
        asym: [ 'KB Split Squat (front rack)', 'Reverse Lunge (KB)', 'KB Suitcase Split Squat' ],
        single: [ 'KB Step-up', 'Pistol to Box (KB)', 'Skater Squat (KB)' ],
      },
      machine: {
        symmetrical: [ 'Hack Squat (V-squat machine)', 'Pendulum Squat', 'Belt Squat' ],
        asym: [ 'V-Squat Split Stance', 'Belt Squat Split Squat', 'Leg Press B-stance' ],
        single: [ 'Single-leg Leg Press', 'V-Squat Step Up', 'Single-leg Hack Squat' ],
      }
    };

    // HINGE
    const hingePools = {
      barbell: {
        symmetrical: [ 'Conventional Deadlift', 'Romanian Deadlift', 'Sumo Deadlift' ],
        asym: [ 'B-stance Deadlift', 'Kickstand RDL', 'B-stance Good Morning' ],
        single: [ 'Single-leg RDL (BB)', 'Single-leg Deadlift (from floor)', 'Sprinter Stance DL (BB)' ],
        bridgeSym: [ 'Barbell Hip Thrust', 'Barbell Glute Bridge', 'Smith Hip Thrust' ],
        bridgeAsym: [ 'B-stance Hip Thrust (BB)', 'Offset-loaded Hip Thrust (BB)', 'B-stance Glute Bridge (BB)' ],
        bridgeSingle: [ 'Single-leg Hip Thrust (BB)', 'Single-leg Glute Bridge (BB)', 'Frog Pump (single-leg)' ],
      },
      dumbbell: {
        symmetrical: [ 'DB RDL', 'DB Good Morning (hip hinge)', 'DB Hip Hinge to box' ],
        asym: [ 'DB B-stance RDL', 'DB Kickstand RDL', 'DB B-stance Good Morning' ],
        single: [ 'Single-leg RDL (DB)', 'Single-leg DL (DB from floor)', 'Sprinter Stance DL (DB)' ],
        bridgeSym: [ 'DB Hip Thrust', 'DB Glute Bridge', 'Feet-elevated DB Hip Thrust' ],
        bridgeAsym: [ 'DB B-stance Hip Thrust', 'DB B-stance Glute Bridge', 'Offset DB Hip Thrust' ],
        bridgeSingle: [ 'Single-leg Hip Thrust (DB)', 'Single-leg Glute Bridge (DB)', 'Single-leg Frog Pump' ],
      },
      kettlebell: {
        symmetrical: [ 'KB RDL (double)', 'KB Good Morning (band assist)', 'KB Swing (hardstyle) *' ],
        asym: [ 'KB B-stance RDL', 'KB Kickstand RDL', 'KB Contralateral RDL' ],
        single: [ 'Single-leg RDL (KB)', 'Sprinter Stance DL (KB)', 'Airborne Lunge Hinge (KB)' ],
        bridgeSym: [ 'KB Hip Thrust', 'KB Glute Bridge', 'Feet-elevated KB Hip Thrust' ],
        bridgeAsym: [ 'KB B-stance Hip Thrust', 'KB B-stance Glute Bridge', 'Offset KB Hip Thrust' ],
        bridgeSingle: [ 'Single-leg Hip Thrust (KB)', 'Single-leg Glute Bridge (KB)', 'Single-leg Frog Pump' ],
      },
      machine: {
        symmetrical: [ 'Back Extension (machine)', '45° Hyperextension', 'Reverse Hyper *' ],
        asym: [ 'Back Extension B-stance (machine)', 'Cable Hip Hinge B-stance', 'Machine Good Morning (if available)' ],
        single: [ 'Single-leg Back Extension (machine)', 'Cable Single-leg RDL', 'Machine Low Back Single-leg' ],
        bridgeSym: [ 'Hip Thrust Machine', 'Glute Drive (machine)', 'Smith Hip Thrust' ],
        bridgeAsym: [ 'Hip Thrust Machine (B-stance)', 'Smith Hip Thrust (B-stance)', 'Glute Drive (offset)' ],
        bridgeSingle: [ 'Hip Thrust Machine (single-leg)', 'Single-leg Glute Drive', 'Smith Single-leg Hip Thrust' ],
      }
    };

    // UPPER PUSH
    const pushPools = {
      barbell: {
        horiz: [ 'Barbell Bench Press', 'Incline Bench Press', 'Close-grip Bench Press' ],
        vert: [ 'Overhead Press (BB)', 'Push Press', 'Z-Press' ],
      },
      dumbbell: {
        horiz: [ 'DB Bench Press', 'DB Incline Bench', 'DB Floor Press' ],
        vert: [ 'DB Shoulder Press', 'Arnold Press', 'Half-kneeling DB Press' ],
      },
      kettlebell: {
        horiz: [ 'KB Floor Press', 'KB Bench Press (double)', 'KB Alternating Floor Press' ],
        vert: [ 'KB Strict Press', 'KB Push Press', 'KB Jerk' ],
      },
      machine: {
        horiz: [ 'RealLeader Chest Press', 'Hammer Strength Chest Press', 'Hammer Strength Incline Press' ],
        vert: [ 'RealLeader Shoulder Press', 'Shoulder Press (machine)', 'Assisted Dip / Dip Machine' ],
      }
    };

    // UPPER PULL
    const pullPools = {
      barbell: {
        horiz: [ 'Barbell Row', 'Pendlay Row', 'Seal Row' ],
        vert: [ 'Upright Row (BB)', 'High Pull (BB)', 'Snatch-grip High Pull' ],
      },
      dumbbell: {
        horiz: [ 'One-arm DB Row', 'Chest-supported DB Row', 'DB Seal Row' ],
        vert: [ 'DB Pullover', 'DB High Pull', 'Incline Bench DB Pullover' ],
      },
      kettlebell: {
        horiz: [ 'KB Gorilla Row', 'One-arm KB Row', 'Chest-supported KB Row' ],
        vert: [ 'KB High Pull', 'KB Upright Row', 'Band-assisted Pull-up with KB belt *' ],
      },
      machine: {
        horiz: [ 'RealLeader Row', 'HammerStrength Row', 'Cable Row' ],
        vert: [ 'Lat Pulldown (wide)', 'Lat Pulldown (close neutral)', 'Gym 80 Lat Pull / Assisted Pull-up' ],
      }
    };

    // Accessories by modality
    const accessories = {
      push: {
        dumbbell: [ 'DB Lateral Raise', 'DB Front Raise', 'DB Fly' ],
        machine: [ 'Pec Fly (machine)', 'Machine Dips', 'Lateral Raise (cable)' ],
        cable: [ 'Cable Lateral Raise', 'Cable Fly (high/low)', 'Overhead Rope Triceps' ],
      },
      pull: {
        dumbbell: [ 'Rear Delt Fly (DB)', 'DB Shrugs', 'DB Face Pull (band)' ],
        machine: [ 'Rear Delt (machine)', 'Face Pull (cable)', 'Shrugs (Trap Bar/Smith)' ],
        cable: [ 'Cable Face Pull', 'Straight-arm Pulldown', 'Cable Rear Delt Fly' ],
      }
    };

    // Core
    const core={
      antiExt:[ 'Ab Wheel Rollout', 'Deadbug (band/KB)', 'RKC Plank' ],
      antiLat:[ 'Suitcase Carry', 'Side Plank (reach-through)', 'Landmine Side Bend Hold' ],
      antiRot:[ 'Pallof Press', 'Tall-kneeling Anti-Rotation', 'Plank + band row' ],
      hipFlex:[ 'Hanging Leg Raise', 'L-sit (rings/parallettes)', 'Reverse Crunch (bench)' ],
      rotation:[ 'Landmine Rotation', 'Russian Twist (MB/plate)', 'Cable Woodchop' ],
    };

    const zone2=[ 'Hardlopen','Row Erg','Ski Erg','Assault Bike','Stairmaster/Traplopen','Spinning Bike' ];
    const hiit={
      plyo:[ 'Burpees','Box Jumps (step-down)','Broad Jumps','Jumping Lunges','Jump Squats','Clap Push-ups' ],
      kbdb:[ 'KB Swings','KB Snatches','KB Clean & Push Press','KB Thrusters','DB Snatch (alt.)','DB Clean & Jerk (alt.)' ],
      medSand:[ 'Wallballs','Medball Slams','Medball Chest Pass','Sandbag Over Shoulder','Sandbag Clean to Carry' ],
      carries:[ 'Farmer Carry Shuttle','Bear Crawl','KB Drag Crawl','Sled Push/Pull','Suitcase Carry (wisselend)' ],
      erg:[ 'Assault Bike Sprints','Row Erg Intervals','Ski Erg Intervals','Battle Ropes','Sled Sprint' ],
      formats:[ 'CHIPPER','LADDER_1_10_1','AMRAP_20','EMOM_30','PARTNER_YGIG' ],
    };

    // ---------- Rotation & Undulating ----------
    const FULL_ROTATION=[ 'S1','Z2','S2','HIIT','S3','Z2','S1','HIIT','S2','Z2','S3','HIIT' ];
    const getRotation=(settings)=>{
      const cz = settings?.cardio?.zone2 ?? true;
      const ch = settings?.cardio?.hiit ?? true;
      const rot = FULL_ROTATION.filter(step => (step!=='Z2' || cz) && (step!=='HIIT' || ch));
      // Fallback: if somehow empty (shouldn't), use strength-only loop
      return rot.length? rot : ['S1','S2','S3','S1','S2','S3'];
    };

    const UNDULATING={
      S1:{ squat:'heavy', upper:'medium', hinge:'light' },
      S2:{ hinge:'heavy', upper:'light', squat:'medium' },
      S3:{ upper:'heavy', squat:'light', hinge:'medium' },
    };

    // ---------- RPE & ranges ----------
    const RPE={ heavy:'RPE 8–9', medium:'RPE 7–8', light:'RPE 6–7', deload:'RPE 5–6' };
    const RANGE_RULES={ strength:{reps:'1–5', start:3, max:5}, hypertrophy:{reps:'6–12', start:3, max:6}, endurance:{reps:'13–20', start:3, max:3} };
    const rangeFromLoad=(x)=> x==='heavy' ? 'strength' : x==='medium' ? 'hypertrophy' : 'endurance';
    const loadPriority=(l)=> l==='heavy'?0 : l==='medium'?1 : 2;

    // ---------- Helpers ----------
    const machineWeight = (load, isDeload, bias) => {
      const b = Math.max(0, Math.min(100, bias||0));
      let base = load==='heavy' ? 0.2 : load==='medium' ? 0.5 : 0.7;
      if(isDeload) base = Math.max(base, 0.8);
      return Math.round(5 * base * (b/100));
    };
    const freeWeight = 5;

    const stanceOrder=['symmetrical','asym','single'];
    const stanceForCycle=(cycleNumber)=> stanceOrder[(cycleNumber-1)%3];

    // ---------- Pickers honoring modality toggles ----------
    const pickSquatByLoad=(load,isDeload,settings,cycleStance=null)=>{
      const mods=settings.modalities||{barbell:true,dumbbell:true,kettlebell:true,machine:true};
      let vari;
      if(load==='heavy') vari = cycleStance || 'symmetrical';
      else if(load==='medium') vari = 'asym';
      else vari = 'single';
      return enabledFrom(mods, squatPools, vari);
    };

    const pickHingeByLoad=(load,isDeload,settings,cycleStance=null)=>{
      const mods=settings.modalities||{barbell:true,dumbbell:true,kettlebell:true,machine:true};
      let vari;
      if(load==='heavy') vari = cycleStance || 'symmetrical';
      else if(load==='medium') vari = 'asym';
      else vari = 'bridgeSym';
      if(load==='light' && Math.random()<0.33) vari='bridgeAsym';
      if(load==='light' && Math.random()<0.33) vari='bridgeSingle';
      return enabledFrom(mods, hingePools, vari);
    };

    function pickUpperPairByLoad(load,isDeload,settings){
      const mods=settings.modalities||{barbell:true,dumbbell:true,kettlebell:true,machine:true};
      const pushVari = Math.random()<0.5? 'horiz':'vert';
      const oppPlane = pushVari==='horiz' ? 'vert' : 'horiz';
      const pCandidates=[]; const cCandidates=[];
      for(const m of Object.keys(mods)){
        if(!mods[m]) continue;
        if(pushPools[m]?.[pushVari]) pCandidates.push(...pushPools[m][pushVari]);
        if(pullPools[m]?.[oppPlane]) cCandidates.push(...pullPools[m][oppPlane]);
      }
      const pushChoice = pCandidates.length? pick(pCandidates) : enabledFrom(mods, pushPools, pushVari);
      const pullChoice = cCandidates.length? pick(cCandidates) : enabledFrom(mods, pullPools, oppPlane);
      const range=rangeFromLoad(load);
      return { push: pushChoice, pull: pullChoice, range };
    }

    const pickAccessories = (settings) => {
      const mods=settings.modalities||{barbell:true,dumbbell:true,kettlebell:true,machine:true};
      const pushAccPool=[]; const pullAccPool=[];
      if(mods.machine){ pushAccPool.push(...(accessories.push.machine||[])); pullAccPool.push(...(accessories.pull.machine||[])); }
      if(mods.dumbbell){ pushAccPool.push(...(accessories.push.dumbbell||[])); pullAccPool.push(...(accessories.pull.dumbbell||[])); }
      if(pushAccPool.length===0) pushAccPool.push('Lateral Raise');
      if(pullAccPool.length===0) pullAccPool.push('Face Pull');
      return { pushAcc: pick(pushAccPool), pullAcc: pick(pullAccPool) };
    };

    const pickCore=(last=-1)=>{ const keys=Object.keys(core); const idx=(last+1)%keys.length; const k=keys[idx]; return { group:k, exercise:pick(core[k]), next:idx }; };
    const pickZone2=()=>({ modality:pick(zone2), minutes:[45,60,75,90][Math.floor(Math.random()*4)], note:'Neusademhaling indien mogelijk' });

    const pickHIIT=()=>{
      const format=pick(hiit.formats);
      const pack={ plyo:pick(hiit.plyo), kbdb:pick(hiit.kbdb), medSand:pick(hiit.medSand), carry:pick(hiit.carries), erg:pick(hiit.erg) };
      const title = format==='CHIPPER' ? 'Chipper 30: full-body' : format==='LADDER_1_10_1' ? 'Ladder 1→10→1' : format==='AMRAP_20' ? 'AMRAP 20' : format==='EMOM_30' ? 'EMOM 30' : 'Partner YGIG (30 min)';
      let blocks=[];
      if(format==='CHIPPER') blocks=[ `50 ${pack.medSand}`, `40 ${pack.kbdb}`, `30 ${pack.plyo}`, `20 ${pack.carry}`, `10 ${pack.erg}` ];
      if(format==='LADDER_1_10_1') blocks=[ `1→10→1: ${pack.kbdb} + ${pack.erg} calories`, 'Kwaliteit > tijd' ];
      if(format==='AMRAP_20') blocks=[ `10 ${pack.plyo}`, `15 ${pack.kbdb}`, `20 ${pack.medSand}`, `200m ${pack.erg}` ];
      if(format==='EMOM_30') blocks=[ `Min 1: 12 ${pack.plyo}`, `Min 2: 15 ${pack.kbdb}`, `Min 3: 12 ${pack.medSand}`, 'Herhaal ×10' ];
      if(format==='PARTNER_YGIG') blocks=[ `200m ${pack.erg}`, `20 ${pack.kbdb}`, `10 ${pack.plyo} over object/partner` ];
      return { title, format, blocks, pack };
    };

    // ---------- Anchors (4-week mains) ----------
    function ensureAnchorsState(state){
      if(state.lockedMains && state.lockedMains.cycleNumber===state.cycleNumber) return state;
      const S=state.settings||def().settings;
      const mkKind=(kind)=>{
        const undu=UNDULATING[kind];
        const heavyStance = S.stanceCycle ? stanceForCycle(state.cycleNumber) : null;
        const squatEx = pickSquatByLoad(undu.squat||'light', false, S, (undu.squat==='heavy')?heavyStance:null);
        const hingeEx = pickHingeByLoad(undu.hinge||'light', false, S, (undu.hinge==='heavy')?heavyStance:null);
        const upper = pickUpperPairByLoad(undu.upper||'medium', false, S);
        return { squatEx, hingeEx, upperPush:upper.push, upperPull:upper.pull };
      };
      const locked={ cycleNumber: state.cycleNumber, S1: mkKind('S1'), S2: mkKind('S2'), S3: mkKind('S3') };
      const newState={ ...state, lockedMains: locked };
      save(newState);
      return newState;
    }

    // ---------- Builders ----------
    function setsByWeek(range, week){
      const base=RANGE_RULES[range];
      if(week===4){
        const wk3 = range==='endurance' ? base.start : Math.min(base.max, base.start+2);
        return Math.max(1, Math.round(wk3 * 0.5));
      }
      if(range==='endurance') return base.start;
      const inc = Math.min(2, week-1);
      return Math.min(base.max, base.start + inc);
    }

    function planFor(range, loadType, week){
      const base=RANGE_RULES[range];
      const reps=base.reps; const sets=setsByWeek(range, week); const rpe= week===4 ? RPE.deload : RPE[loadType];
      return {reps, sets, rpe};
    }

    function buildStrength(kind, state){
      const st=ensureAnchorsState(state);
      const undu=UNDULATING[kind];
      const week=st.cycleWeek;

      const coreSel=pickCore(st.lastCoreIndex);
      const warmupBlock = { label:`CORE (${coreSel.group}) — WARM-UP`, exercise:coreSel.exercise, reps:'10–20 / 20–45 sec', sets:setsByWeek('endurance', week), rpe:week===4?RPE.deload:'RPE 6–7', _load:'warm' };

      const mainsAnchor = st.lockedMains ? st.lockedMains[kind] : null;
      const sLoad=undu.squat||'light'; const sRange=rangeFromLoad(sLoad);
      const hLoad=undu.hinge||'light'; const hRange=rangeFromLoad(hLoad);
      const uLoad=undu.upper||'medium'; const uRange=rangeFromLoad(uLoad);

      const mainBlocks = [
        { label:`SQUAT (${sLoad.toUpperCase()})`, exercise:mainsAnchor?mainsAnchor.squatEx:'—', ...planFor(sRange,sLoad,week), _load:sLoad },
        { label:`UPPER SUPERSET (${uLoad.toUpperCase()})`, exercise:mainsAnchor?`${mainsAnchor.upperPush}  //  ${mainsAnchor.upperPull}`:'—', ...planFor(uRange,uLoad,week), _load:uLoad },
        { label:`HINGE (${hLoad.toUpperCase()})`, exercise:mainsAnchor?mainsAnchor.hingeEx:'—', ...planFor(hRange,hLoad,week), _load:hLoad },
      ].sort((a,b)=> loadPriority(a._load) - loadPriority(b._load));

      const acc=pickAccessories(st.settings);
      const accessoriesBlocks = [
        { label:'PUSH ACCESSORY', exercise:acc.pushAcc, reps:'12–20', sets: week===4?2:3, rpe: week===4?RPE.deload:'RPE 7–8' },
        { label:'PULL ACCESSORY', exercise:acc.pullAcc, reps:'12–20', sets: week===4?2:3, rpe: week===4?RPE.deload:'RPE 7–8' },
        { label:'OPTIONEEL: Biceps', exercise:pick(['Barbell Curl','Incline DB Curl','Hammer Curl','Cable Curl']), reps:'12–15', sets:2, rpe:'RPE 7–8', optional:true },
        { label:'OPTIONEEL: Triceps', exercise:pick(['Rope Pushdown','Skullcrusher (EZ/DB)','Overhead Rope Ext.','Assisted Dip (sets of 12)']), reps:'12–15', sets:2, rpe:'RPE 7–8', optional:true },
        { label:'OPTIONEEL: Calves', exercise:pick(['Standing Calf Raise (machine)','Seated Calf Raise (machine)','Toe Farmer Carry']), reps:'12–20', sets:2, rpe:'RPE 7–8', optional:true },
      ];

      return {
        type:'STRENGTH',
        title:`Kracht ${kind}`,
        date:todayStr(),
        isDeload: week===4,
        blocks:[ warmupBlock, ...mainBlocks, ...accessoriesBlocks ],
        meta:{ rpeGuide: week===4?RPE.deload:`Heavy=${RPE.heavy}, Medium=${RPE.medium}, Light=${RPE.light}`, nextCoreIndex:coreSel.next }
      };
    }

    function buildZone2(){ const z=pickZone2(); return { type:'ZONE2', title:`Zone 2 — ${z.minutes} min`, date:todayStr(), detail:`${z.modality} · ${z.minutes} minuten`, note:z.note }; }
    function buildHIIT(){ const H=pickHIIT(); return { type:'HIIT', title:H.title, date:todayStr(), format:H.format, blocks:H.blocks, pack:H.pack }; }

    function buildNext(state){
      const ROT = getRotation(state.settings);
      const step=ROT[state.rotationIndex % ROT.length];
      let session; if(step==='Z2') session=buildZone2(); else if(step==='HIIT') session=buildHIIT(); else session=buildStrength(step,state);
      return {step,session,state};
    }

    function advance(state, completed){
      let s={...state};
      const ROT = getRotation(s.settings);
      s.rotationIndex=(s.rotationIndex+1)%ROT.length;
      if(completed && completed.title && completed.title.indexOf('Kracht S3')>=0){
        s.cycleWeek = s.cycleWeek===4 ? 1 : s.cycleWeek+1;
        if(s.cycleWeek===1) s.cycleNumber+=1;
      }
      return s;
    }

    // ---------- UI ----------
    const Badge=({children})=> <span className="chip">{children}</span>;
    const Section=({title, right, children})=> (
      <div className="card p-4 sm:p-6 mb-4">
        <div className="flex items-center justify-between mb-3 gap-3">
          <h3 className="text-lg font-semibold">{title}</h3>
          {right}
        </div>
        {children}
      </div>
    );

    function StrengthView({s}){
      const blocks=s.blocks;
      const isMain=(b)=> b.label.startsWith('SQUAT') || b.label.startsWith('UPPER SUPERSET') || b.label.startsWith('HINGE');
      const isAcc=(b)=> b.label.indexOf('ACCESSORY')>=0;
      const isCore=(b)=> b.label.startsWith('CORE');
      const warmup=blocks.find(isCore);
      const mains=blocks.filter(isMain);
      const accessories=blocks.filter(isAcc);
      const optionals=blocks.filter(b=>b.optional);

      const Card = ({b, tone}) => (
        <div className={'p-3 rounded-xl border '+(tone==='warm' ? 'bg-emerald-50/60 dark:bg-emerald-950/30 border-emerald-200/60 dark:border-emerald-900/50' : tone==='main' ? 'bg-indigo-50/60 dark:bg-indigo-950/30 border-indigo-200/60 dark:border-indigo-900/50' : tone==='acc'  ? 'bg-zinc-50 dark:bg-zinc-950/40 border-black/10 dark:border-white/10' : 'bg-amber-50 dark:bg-amber-950/30 border-amber-200/60 dark:border-amber-900/50')}>
          <div className="flex items-baseline justify-between gap-2">
            <div className="font-semibold">{b.label}</div>
            {b.optional && <Badge>Optioneel</Badge>}
          </div>
          <div className="mt-1">{b.exercise}</div>
          <div className="mt-1 text-sm muted">{b.sets} sets × {b.reps} · {b.rpe}</div>
        </div>
      );

      return (
        <div className="space-y-4">
          <div className="p-3 rounded-xl bg-white/70 dark:bg-zinc-950/50 border border-black/10 dark:border-white/10">
            <div className="text-sm muted">RPE gids: {s.meta.rpeGuide}</div>
            <div className="mt-2 flex flex-wrap gap-2">
              <Badge>Warming-up (Core)</Badge>
              {mains.map((b,i)=>(<Badge key={i}>{b.label.split(' ')[0]}: {b.reps}</Badge>))}
              <Badge>Accessories</Badge>
              {optionals.length>0 && <Badge>Arms/Calves (opt.)</Badge>}
            </div>
          </div>
          {warmup && (
            <div>
              <h4 className="text-sm uppercase tracking-wide muted mb-2">Warming-up — Core</h4>
              <Card b={warmup} tone="warm"/>
            </div>
          )}
          <div>
            <h4 className="text-sm uppercase tracking-wide muted mb-2">Hoofdblok (Zwaar → Medium → Licht)</h4>
            <div className="grid grid-cols-1 gap-3">
              {mains.map((b,i)=>(<Card key={i} b={b} tone="main"/>))}
            </div>
          </div>
          <div>
            <h4 className="text-sm uppercase tracking-wide muted mb-2">Accessories</h4>
            <div className="grid grid-cols-1 gap-3">
              {accessories.map((b,i)=>(<Card key={i} b={b} tone="acc"/>))}
            </div>
          </div>
          {optionals.length>0 && (
            <div>
              <h4 className="text-sm uppercase tracking-wide muted mb-2">Optioneel — als er tijd/energie is</h4>
              <div className="grid grid-cols-1 gap-3">
                {optionals.map((b,i)=>(<Card key={i} b={b}/>))}
              </div>
            </div>
          )}
        </div>
      );
    }

    function HiitView({h}){
      return (
        <div className="space-y-2">
          <div className="p-3 rounded-xl bg-emerald-50 dark:bg-emerald-950/30 border border-emerald-200/50 dark:border-emerald-900/40">
            <div className="font-medium">Format: {h.format.replace(/_/g,' ')}</div>
            <ul className="mt-2 list-disc pl-6 space-y-1">
              {h.blocks.map((x,i)=>(<li key={i}>{x}</li>))}
            </ul>
            <div className="text-sm muted mt-2">Warming-up 5–8 min · Cool-down 5 min</div>
          </div>
        </div>
      );
    }

    function Zone2View({z}){
      return (
        <div className="space-y-2">
          <div className="p-3 rounded-xl bg-blue-50 dark:bg-blue-950/30 border border-blue-200/50 dark:border-blue-900/40">
            <div className="font-medium">{z.detail}</div>
            <div className="text-sm muted mt-1">Adem rustig; praat-test: je kunt zinnen spreken. {z.note}</div>
            <div className="text-sm mt-2">RPE 5–6 · 65–75% HRmax</div>
          </div>
        </div>
      );
    }

    function Settings({state,setState,setCurrent}){
      const s=state.settings||def().settings;
      const [open,setOpen]=useState(false);

      const startNewCycle=()=>{
        if(!confirm('Nieuwe cyclus starten met huidige instellingen? Week → 1, mains worden opnieuw gekozen.')) return;
        const next={...state, cycleNumber: state.cycleNumber+1, cycleWeek:1, lockedMains:null};
        save(next);
        setState(next);
        setCurrent(buildNext(next));
        window.scrollTo({top:0,behavior:'smooth'});
      };

      const regenMains=()=>{
        if(!confirm('Mains opnieuw genereren voor huidige cyclus met huidige instellingen? (Week blijft gelijk)')) return;
        const next={...state, lockedMains:null};
        save(next);
        setState(next);
        setCurrent(buildNext(next));
      };

      const resetProgress=()=>{
        if(!confirm('Alle voortgang resetten maar instellingen behouden? (Historie, week, cyclus → reset)')) return;
        const keepSettings = state.settings;
        const next={...def(), settings: keepSettings};
        save(next);
        setState(next);
        setCurrent(buildNext(next));
      };

      const factoryReset=()=>{
        if(!confirm('Volledige reset uitvoeren? (Alles inclusief instellingen wordt gewist)')) return;
        localStorage.removeItem(LS_KEY);
        location.reload();
      };

      return (
        <details className="settings" open={open} onToggle={(e)=>setOpen(e.currentTarget.open)}>
          <summary>
            <div className="card p-4 sm:p-6 mb-2 flex items-center justify-between cursor-pointer">
              <div className="font-semibold">Instellingen</div>
              <span className="chip">{open? 'Sluit' : 'Open'}</span>
            </div>
          </summary>
          <div className="card p-4 sm:p-6 mb-4 space-y-4">
            <div className="grid-2 items-center">
              <label className="flex items-center gap-2"><input type="checkbox" checked={s.machines} onChange={e=>setState({...state, settings:{...s, machines:e.target.checked}})} /> Machines preferentie aan</label>
              <div className="flex items-center gap-3">
                <span className="muted text-sm" style={{minWidth:90}}>Machine bias</span>
                <input className="w-full" type="range" min="0" max="100" value={s.machineBias} onChange={e=>setState({...state, settings:{...s, machineBias:parseInt(e.target.value,10)}})} />
                <span className="mono text-sm">{s.machineBias}%</span>
              </div>
              <label className="flex items-center gap-2"><input type="checkbox" checked={s.stanceCycle} onChange={e=>setState({...state, settings:{...s, stanceCycle:e.target.checked}})} /> Stance-cyclus heavy (sym → asym → single)</label>
            </div>
            <div className="mt-2">
              <div className="font-semibold mb-2">Modaliteiten aan/uit</div>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                {Object.entries(s.modalities).map(([k,v])=> (
                  <label key={k} className="flex items-center gap-2 p-2 rounded-lg border border-black/10 dark:border-white/10">
                    <input type="checkbox" checked={v} onChange={e=>setState({...state, settings:{...s, modalities:{...s.modalities, [k]: e.target.checked}}})} /> {k}
                  </label>
                ))}
              </div>
            </div>

            <div className="mt-2">
              <div className="font-semibold mb-2">Cardio in rotatie</div>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                <label className="flex items-center gap-2 p-2 rounded-lg border border-black/10 dark:border-white/10">
                  <input type="checkbox" checked={s.cardio?.zone2??true} onChange={e=>setState({...state, settings:{...s, cardio:{...s.cardio, zone2:e.target.checked}}})} /> Zone 2
                </label>
                <label className="flex items-center gap-2 p-2 rounded-lg border border-black/10 dark:border-white/10">
                  <input type="checkbox" checked={s.cardio?.hiit??true} onChange={e=>setState({...state, settings:{...s, cardio:{...s.cardio, hiit:e.target.checked}}})} /> HIIT
                </label>
              </div>
              <p className="text-xs muted mt-1">Zet uit voor klanten die zelf hun hardlopen/interval doen. Rotatie past zich direct aan.</p>
            </div>

            <div className="grid sm:grid-cols-2 gap-2">
              <button className="btn" onClick={startNewCycle}>Nieuwe cyclus met huidige instellingen</button>
              <button className="btn ghost" onClick={regenMains}>Her-genereer mains (huidige cyclus)</button>
            </div>
            <div className="grid sm:grid-cols-2 gap-2">
              <button className="btn ghost" onClick={resetProgress}>Reset voortgang (behoud instellingen)</button>
              <button className="btn" style={{background:'#dc2626'}} onClick={factoryReset}>Volledige reset</button>
            </div>
          </div>
        </details>
      );
    }

    function App(){
      const [state,setState]=useState(load());
      const [current,setCurrent]=useState(()=>buildNext(load()));
      const [showHistory,setShowHistory]=useState(false);
      useEffect(()=>{ save(state); },[state]);
      useEffect(()=>{
        const ensured=ensureAnchorsState(state);
        if(ensured!==state){ setState(ensured); setCurrent(buildNext(ensured)); }
      },[]);

      const complete=()=>{
        const entry={ date:current.session.date, kind:current.session };
        const nstate={...state, history:[...state.history, entry], lastCoreIndex:(current.session.meta?.nextCoreIndex ?? state.lastCoreIndex) };
        const adv=advance(nstate, current.session);
        const ensured=ensureAnchorsState(adv);
        setState(ensured);
        setCurrent(buildNext(ensured));
        window.scrollTo({top:0,behavior:'smooth'});
      };
      const skip=()=>{ const adv={...state, rotationIndex:(state.rotationIndex+1)%getRotation(state.settings).length}; const ensured=ensureAnchorsState(adv); setState(ensured); setCurrent(buildNext(ensured)); };
      const reset=()=>{ if(confirm('Alles resetten?')){ localStorage.removeItem(LS_KEY); location.reload(); } };

      const ROT = getRotation(state.settings);

      return (
        <div className="space-y-4">
          <header className="flex items-center justify-between sticky top-0 z-30 bg-white/70 dark:bg-black/40 backdrop-blur px-1 py-2 rounded-b-xl">
            <div>
              <h1 className="text-2xl font-bold">OmniFlow Trainer</h1>
              <p className="muted text-sm">Stap: <span className="mono">{ROT[state.rotationIndex % ROT.length]}</span> · Week <span className="mono">{state.cycleWeek}</span> {state.cycleWeek===4 && <span className="chip">DELOAD</span>} · Cyclus <span className="mono">{state.cycleNumber}</span></p>
            </div>
            <div className="hidden sm:flex items-center gap-2">
              <button className="btn" onClick={()=>setShowHistory(v=>!v)}>{showHistory? 'Verberg' : 'Toon'} historie</button>
              <button className="btn ghost" onClick={skip} title="Sla over">Skip</button>
              <button className="btn" style={{background:'#dc2626'}} onClick={reset}>Factory reset</button>
            </div>
          </header>

          <div className="sm:hidden grid grid-cols-2 gap-2">
            <button className="btn" onClick={()=>setShowHistory(v=>!v)}>{showHistory? 'Verberg' : 'Historie'}</button>
            <button className="btn ghost" onClick={skip}>Skip</button>
          </div>

          <Settings state={state} setState={setState} setCurrent={setCurrent} />

          <Section title={`${current.session.title} — ${current.session.date}`} right={<span className="chip">{ROT[state.rotationIndex % ROT.length]}</span>}>
            {current.session.type==='STRENGTH' && <StrengthView s={current.session} />}
            {current.session.type==='ZONE2' && <Zone2View z={current.session} />}
            {current.session.type==='HIIT' && <HiitView h={current.session} />}
            <div className="mt-4 flex gap-2">
              <button className="btn w-full sm:w-auto" onClick={complete}>Complete → volgende</button>
              <button className="btn ghost w-full sm:w-auto" onClick={skip}>Skip</button>
            </div>
          </Section>

          {showHistory && (
            <Section title={`Historie (${state.history.length})`}>
              {state.history.length===0 && <p className="muted">Nog geen sessies voltooid.</p>}
              <div className="grid grid-cols-1 gap-3">
                {[...state.history].reverse().map((h,idx)=>(
                  <div className="p-3 rounded-xl bg-white/70 dark:bg-zinc-950/40 border border-black/10 dark:border-white/10" key={idx}>
                    <div className="text-sm muted">{h.date}</div>
                    <div className="font-medium">{h.kind.title}</div>
                    {h.kind.type==='STRENGTH' ? (
                      <ul className="mt-1 text-sm list-disc pl-6 space-y-0.5">
                        {h.kind.blocks.map((b,i)=>(<li key={i}>{b.label}: {b.exercise} · {b.sets}×{b.reps}</li>))}
                      </ul>
                    ) : (
                      <div className="text-sm mt-1">{h.kind.type==='ZONE2' ? h.kind.detail : h.kind.blocks.join(' · ')}</div>
                    )}
                  </div>
                ))}
              </div>
            </Section>
          )}

          <div className="stickybar">
            <div className="stickywrap p-2 flex gap-2">
              <button className="btn w-full" onClick={complete}>Complete</button>
              <button className="btn ghost w-full" onClick={skip}>Skip</button>
            </div>
          </div>

          <footer className="pt-4 pb-8 text-center muted text-xs">
            <p>OmniFlow Trainer · 3:1 doordraai · 4 weken vaste mains · RPE · Stance-cyclus heavy · Modaliteit & cardio toggles · {new Date().getFullYear()}</p>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
